<html>
<head>
<meta charset="UTF-8">
<title>Personal Flight History</title>
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6/leaflet.css" />
<!--[if lte IE 8]>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6/leaflet.ie.css" />
<![endif]-->
<script src="http://cdn.leafletjs.com/leaflet-0.6/leaflet.js"></script>
<script src="arc.js"></script>
<style type="text/css">

html, body {
 margin: 0;
 padding: 0;
}

#infopane {
 float: left;
 width: 200px;
 height: 100%;
 overflow: auto;
 background: #ccc;
 font-size: 11px;
 color: #444;
}

h1 {
 margin: 0;
 padding: 10px;
 font-size: 14px;
 background: #888;
 color: white;
}

p {
 margin: 10px;
}

a {
 color: #48F;
}

#credits {
 border-top: 1px solid #AAA;
 padding-top: 5px;
 font-size: 9px;
 color: #888;
}

#credits a {
 color: #8AF;
}

#map {
 margin-left: 150px;
 height: 100%;
}

.iata {
 display: block;
 font-size: 20px;
}

.airport_name {
 font-size: 10px;
}

</style>
</head>
<body>
<div id="infopane">
<h1>Eugeneâ€™s Flight History</h1>
</div>
<div id="map"></div>
</body>
<script type="text/javascript">

var LONG_LIMIT = -120;

var XhrObject = new XMLHttpRequest();

var Map;
var LayersControl;

function init() {

   // Specify default map location
   var initLat  = 14.5;
   var initLng  = 121;
   var initZoom = 4;

   // Initialize the map and permalink
   Map = new L.Map('map', {
      center : new L.LatLng(initLat, initLng),
      zoom   : initZoom
   });

   // Declare tile layer control data object
   var tilesLayers = new Object;

   // Create the MapQuest tile layer
   var mapquestURL = 'http://{s}.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png';
   var mapquestLayer = new L.TileLayer(mapquestURL, {
      subdomains  : ['otile1', 'otile2', 'otile3', 'otile4'],
      attribution : 'Tiles &copy; <a href="http://open.mapquest.com/">MapQuest</a>',
   });
   tilesLayers["MapQuest"] = mapquestLayer;

   // Create the Stamen Toner tile layer
   var stamenTonerURL = 'http://{s}.tile.stamen.com/toner/{z}/{x}/{y}.png';
   var stamenTonerLayer = new L.TileLayer(stamenTonerURL, {
      attribution : 'Tiles &copy; <a href="http://maps.stamen.com/#toner">Stamen</a> (CC-BY 3.0)',
   });
   tilesLayers["Stamen Toner"] = stamenTonerLayer;

   // Add the MapQuest tile layer to the map (default)
   Map.addLayer(mapquestLayer);

   // Add layer control to map (base layers first)
   LayersControl = new L.Control.Layers(tilesLayers);
   Map.addControl(LayersControl);

   // Load the overlay data
   XhrObject.onreadystatechange = processData;
   XhrObject.open('GET', 'data.json', true);
   XhrObject.overrideMimeType('text/plain');
   XhrObject.send(null);
}

function processData() {

   if (XhrObject.readyState != 4) return;

   // Parse the data
   var data = JSON.parse(XhrObject.responseText);

   // Process the data

   var airportsHash = new Object;
   
   for (var i = 0; i < data.trips.length; i++) {

      var legsData = data.trips[i].legs;

      for (var j = 0; j < legsData.length; j++) {
      
         var leg = legsData[j];
         var nodes = [leg.departure.airport];
         if (leg.stops) nodes.push(leg.stops);
         nodes.push(leg.arrival.airport);
         airportsHash[leg.arrival.airport] = true;
         
         for (var k = 0; k < nodes.length - 1; k++) {
         
            airportsHash[nodes[k]] = true;

            var start0 = data.airports[nodes[k  ]];
            var end0   = data.airports[nodes[k+1]];
            var start  = new arc.Coord(start0.lon, start0.lat);
            var end    = new arc.Coord(end0.lon,   end0.lat  );
            var line   = new arc.GreatCircle(start, end, {
               'Flight No.': leg.flightNum
            }).Arc(20);

            var coords = [];
            for (var l = 0; l < line.geometries.length; l++) {
               coords[l] = [];
               for (var m = 0; m < line.geometries[l].coords.length; m++) {
                  if (line.geometries[l].coords[m][0] < LONG_LIMIT) {
                     line.geometries[l].coords[m][0] += 360;
                  }
                  coords[l][m] = new L.LatLng(
                     line.geometries[l].coords[m][1],
                     line.geometries[l].coords[m][0]
                  );
               }
            }

            var layer = L.geoJson(line.json(), {
               style: function() {
                  return {
                     stroke  : true,
                     color   : '#F88',
                     opacity : 0.6,
                     weight  : 5,
                  }
               }
            });
            
            Map.addLayer(layer);
         }
      }
   }
   
   var airports = Object.keys(airportsHash)
   for (var i = 0; i < airports.length; i++) {
      var airportData = data.airports[airports[i]];
      var popupMsg = '<strong class="iata">' + airports[i] + '</strong>'
         + '<span class="airport_name">' + airportData.name + '</span>';
      var marker = L.marker([airportData.lat, airportData.lon]).addTo(Map);
      marker.bindPopup(popupMsg);
   }
}

init();

</script>
</html>
